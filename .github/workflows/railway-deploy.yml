name: 🚄 Railway Deploy (Manual)

on:
  workflow_dispatch:
    inputs:
      target:
        description: "Which service to deploy"
        required: true
        default: "both"
        type: choice
        options:
          - backend
          - frontend
          - both
      vite_enable_admin_panel:
        description: "Enable admin panel on frontend (VITE_ENABLE_ADMIN_PANEL)"
        required: false
        default: "true"
      enable_registration:
        description: "Backend ENABLE_REGISTRATION (true/false)"
        required: false
        default: "false"
      environment:
        description: "Railway environment (e.g., production, staging, dev)"
        required: false
        default: "production"
      project_id:
        description: "Railway Project ID (recommended for CI)"
        required: false
        type: string

jobs:
  deploy:
    name: Deploy to Railway
    runs-on: ubuntu-latest
    env:
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      RAILWAY_PROJECT_ID: ${{ github.event.inputs.project_id || secrets.RAILWAY_PROJECT_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '22'

      - name: Install Railway CLI
        run: npm i -g @railway/cli

      - name: Authenticate Railway
        run: |
          if [ -n "$RAILWAY_TOKEN" ]; then
            railway login --token "$RAILWAY_TOKEN" || true
          fi
          railway whoami || echo "Proceeding with token-based auth (token-only)"

      - name: Set project and environment (if provided)
        run: |
          if [ -n "$RAILWAY_PROJECT_ID" ]; then
            echo "Using Railway project: $RAILWAY_PROJECT_ID"
          else
            echo "Note: RAILWAY_PROJECT_ID not provided; relying on CLI defaults or previous link."
          fi

      - name: Preflight validation
        run: |
          set -e
          echo "Validating Railway token..."
          if ! railway whoami >/dev/null 2>&1; then
            echo "❌ Invalid or missing RAILWAY_TOKEN. Please add a valid Project Token to repo secrets."
            exit 1
          fi

          echo "Selecting environment '${{ github.event.inputs.environment }}'..."
          if ! railway environment "${{ github.event.inputs.environment }}" >/dev/null 2>&1; then
            echo "❌ Could not select environment '${{ github.event.inputs.environment }}'. Ensure it exists in the Railway project tied to your token."
            echo "   Tip: Use a Project Token (Project → Settings → Tokens) and create the environment in Railway UI if needed."
            exit 1
          fi

          {
            echo "## Railway Preflight"; echo
            echo "- ✅ Token valid"
            echo "- ✅ Project: $RAILWAY_PROJECT_ID"
            echo "- ✅ Environment: ${{ github.event.inputs.environment }}"
          } >> $GITHUB_STEP_SUMMARY

      - name: Deploy backend
        if: ${{ github.event.inputs.target == 'backend' || github.event.inputs.target == 'both' }}
        working-directory: backend
        env:
          ENABLE_REGISTRATION: ${{ github.event.inputs.enable_registration }}
          RAILWAY_ENVIRONMENT: ${{ github.event.inputs.environment }}
          RAILWAY_SERVICE: backend
        run: |
          echo "Deploying backend..."
          # Set variables (new CLI expects --set as option, not subcommand)
          if [ -n "$ENABLE_REGISTRATION" ]; then
            railway variables --service backend --environment "$RAILWAY_ENVIRONMENT" ENABLE_REGISTRATION=$ENABLE_REGISTRATION || true
          fi
          # Deploy backend targeting service+environment; path is current dir
          railway up --service backend --environment "$RAILWAY_ENVIRONMENT" .

      - name: Deploy frontend
        if: ${{ github.event.inputs.target == 'frontend' || github.event.inputs.target == 'both' }}
        working-directory: frontend
        env:
          VITE_ENABLE_ADMIN_PANEL: ${{ github.event.inputs.vite_enable_admin_panel }}
          RAILWAY_ENVIRONMENT: ${{ github.event.inputs.environment }}
          RAILWAY_SERVICE: frontend
        run: |
          echo "Deploying frontend..."
          if [ -n "$VITE_ENABLE_ADMIN_PANEL" ]; then
            railway variables --service frontend --environment "$RAILWAY_ENVIRONMENT" VITE_ENABLE_ADMIN_PANEL=$VITE_ENABLE_ADMIN_PANEL || true
          fi
          railway up --service frontend --environment "$RAILWAY_ENVIRONMENT" .

      - name: Summary
        run: |
          echo "## Railway Deploy" >> $GITHUB_STEP_SUMMARY
          echo "Target: ${{ github.event.inputs.target }}" >> $GITHUB_STEP_SUMMARY
          echo "Admin panel: ${{ github.event.inputs.vite_enable_admin_panel }}" >> $GITHUB_STEP_SUMMARY
          echo "Enable registration: ${{ github.event.inputs.enable_registration }}" >> $GITHUB_STEP_SUMMARY
          echo "Environment: ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY

<!DOCTYPE html><meta charset="utf-8"/><p><em>Last updated: 2025-09-19</em></p>
<h2 id="overview">Overview</h2>
<p>This guide provides technical procedures for handling GDPR data requests in LeafLock. Our zero-knowledge architecture means most user data is encrypted client-side, but we still need processes for the limited server-side data we do store.</p>
<h2 id="architecture-summary">Architecture Summary</h2>
<p>LeafLock uses a GDPR-compliant encryption system:</p>
<ul>
<li><strong>Email addresses</strong>: Encrypted with unique GDPR deletion keys</li>
<li><strong>Email hashes</strong>: SHA-256 hashes for uniqueness constraints</li>
<li><strong>Search hashes</strong>: Deterministic encryption for login lookups</li>
<li><strong>GDPR keys</strong>: Separate table storing deletion keys for email recovery</li>
</ul>
<h2 id="data-request-procedures">Data Request Procedures</h2>
<h3 id="automated-gdpr-endpoints">Automated GDPR Endpoints</h3>
<p>The system provides automated endpoints for common requests:</p>
<h4 id="data-export-request">Data Export Request</h4>
<pre class="astro-code dark-plus" style="background-color:#1E1E1E;color:#D4D4D4;overflow-x:auto" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#DCDCAA">curl</span><span style="color:#569CD6"> -X</span><span style="color:#CE9178"> POST</span><span style="color:#CE9178"> https://your-domain.com/api/v1/gdpr/request</span><span style="color:#D7BA7D"> \</span></span>
<span class="line"><span style="color:#569CD6">  -H</span><span style="color:#CE9178"> &quot;Content-Type: application/json&quot;</span><span style="color:#D7BA7D"> \</span></span>
<span class="line"><span style="color:#569CD6">  -d</span><span style="color:#CE9178"> &#39;{&quot;email&quot;: &quot;user@example.com&quot;}&#39;</span></span></code></pre>
<p><strong>Response includes:</strong></p>
<ul>
<li>User ID</li>
<li>Account creation date</li>
<li>Confirmation message about encrypted notes</li>
</ul>
<h4 id="account-deletion-request">Account Deletion Request</h4>
<pre class="astro-code dark-plus" style="background-color:#1E1E1E;color:#D4D4D4;overflow-x:auto" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#DCDCAA">curl</span><span style="color:#569CD6"> -X</span><span style="color:#CE9178"> DELETE</span><span style="color:#CE9178"> https://your-domain.com/api/v1/gdpr/delete</span><span style="color:#D7BA7D"> \</span></span>
<span class="line"><span style="color:#569CD6">  -H</span><span style="color:#CE9178"> &quot;Content-Type: application/json&quot;</span><span style="color:#D7BA7D"> \</span></span>
<span class="line"><span style="color:#569CD6">  -d</span><span style="color:#CE9178"> &#39;{&quot;email&quot;: &quot;user@example.com&quot;}&#39;</span></span></code></pre>
<p><strong>This permanently removes:</strong></p>
<ul>
<li>User account and all associated data</li>
<li>All encrypted notes (cascading delete)</li>
<li>Session data</li>
<li>Audit logs</li>
<li>GDPR deletion keys</li>
</ul>
<h2 id="manual-administrative-procedures">Manual Administrative Procedures</h2>
<h3 id="email-recovery-for-support">Email Recovery for Support</h3>
<p>If you need to recover a user’s email for legitimate support purposes:</p>
<ol>
<li><strong>Get the user’s email hash:</strong></li>
</ol>
<pre class="astro-code dark-plus" style="background-color:#1E1E1E;color:#D4D4D4;overflow-x:auto" tabindex="0" data-language="sql"><code><span class="line"><span style="color:#569CD6">SELECT</span><span style="color:#D4D4D4"> email_hash </span><span style="color:#569CD6">FROM</span><span style="color:#D4D4D4"> users </span><span style="color:#569CD6">WHERE</span><span style="color:#D4D4D4"> id = </span><span style="color:#CE9178">&#39;user-uuid-here&#39;</span><span style="color:#D4D4D4">;</span></span></code></pre>
<ol start="2">
<li><strong>Retrieve the GDPR deletion key:</strong></li>
</ol>
<pre class="astro-code dark-plus" style="background-color:#1E1E1E;color:#D4D4D4;overflow-x:auto" tabindex="0" data-language="sql"><code><span class="line"><span style="color:#569CD6">SELECT</span><span style="color:#D4D4D4"> deletion_key </span><span style="color:#569CD6">FROM</span><span style="color:#D4D4D4"> gdpr_keys </span><span style="color:#569CD6">WHERE</span><span style="color:#D4D4D4"> email_hash = </span><span style="color:#CE9178">&#39;hash-from-step-1&#39;</span><span style="color:#D4D4D4">;</span></span></code></pre>
<ol start="3">
<li><strong>Decrypt the email (Go code example):</strong></li>
</ol>
<pre class="astro-code dark-plus" style="background-color:#1E1E1E;color:#D4D4D4;overflow-x:auto" tabindex="0" data-language="go"><code><span class="line"><span style="color:#6A9955">// This should only be done by authorized administrators</span></span>
<span class="line"><span style="color:#9CDCFE">encryptedEmail</span><span style="color:#D4D4D4"> := </span><span style="color:#DCDCAA">getUserEncryptedEmail</span><span style="color:#D4D4D4">(</span><span style="color:#9CDCFE">userID</span><span style="color:#D4D4D4">)</span></span>
<span class="line"><span style="color:#9CDCFE">deletionKey</span><span style="color:#D4D4D4"> := </span><span style="color:#DCDCAA">getGDPRKey</span><span style="color:#D4D4D4">(</span><span style="color:#9CDCFE">emailHash</span><span style="color:#D4D4D4">)</span></span>
<span class="line"><span style="color:#9CDCFE">email</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">err</span><span style="color:#D4D4D4"> := </span><span style="color:#9CDCFE">crypto</span><span style="color:#D4D4D4">.</span><span style="color:#DCDCAA">DecryptWithGDPRKey</span><span style="color:#D4D4D4">(</span><span style="color:#9CDCFE">encryptedEmail</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">deletionKey</span><span style="color:#D4D4D4">)</span></span></code></pre>
<p><strong>⚠️ Important:</strong> Only decrypt emails when absolutely necessary for legitimate support or legal requests.</p>
<h3 id="manual-user-deletion">Manual User Deletion</h3>
<p>For manual deletion (if automated endpoint fails):</p>
<ol>
<li>
<p><strong>Verify user identity</strong> using the email verification process above</p>
</li>
<li>
<p><strong>Start database transaction:</strong></p>
</li>
</ol>
<pre class="astro-code dark-plus" style="background-color:#1E1E1E;color:#D4D4D4;overflow-x:auto" tabindex="0" data-language="sql"><code><span class="line"><span style="color:#569CD6">BEGIN</span><span style="color:#D4D4D4">;</span></span></code></pre>
<ol start="3">
<li><strong>Delete user (cascades to notes, sessions, etc.):</strong></li>
</ol>
<pre class="astro-code dark-plus" style="background-color:#1E1E1E;color:#D4D4D4;overflow-x:auto" tabindex="0" data-language="sql"><code><span class="line"><span style="color:#569CD6">DELETE</span><span style="color:#569CD6"> FROM</span><span style="color:#D4D4D4"> users </span><span style="color:#569CD6">WHERE</span><span style="color:#D4D4D4"> email_hash = </span><span style="color:#CE9178">&#39;verified-email-hash&#39;</span><span style="color:#D4D4D4">;</span></span></code></pre>
<ol start="4">
<li><strong>Delete GDPR key:</strong></li>
</ol>
<pre class="astro-code dark-plus" style="background-color:#1E1E1E;color:#D4D4D4;overflow-x:auto" tabindex="0" data-language="sql"><code><span class="line"><span style="color:#569CD6">DELETE</span><span style="color:#569CD6"> FROM</span><span style="color:#D4D4D4"> gdpr_keys </span><span style="color:#569CD6">WHERE</span><span style="color:#D4D4D4"> email_hash = </span><span style="color:#CE9178">&#39;verified-email-hash&#39;</span><span style="color:#D4D4D4">;</span></span></code></pre>
<ol start="5">
<li><strong>Commit transaction:</strong></li>
</ol>
<pre class="astro-code dark-plus" style="background-color:#1E1E1E;color:#D4D4D4;overflow-x:auto" tabindex="0" data-language="sql"><code><span class="line"><span style="color:#569CD6">COMMIT</span><span style="color:#D4D4D4">;</span></span></code></pre>
<h3 id="data-export-for-legal-requests">Data Export for Legal Requests</h3>
<p>For comprehensive data export:</p>
<ol>
<li><strong>Identify user</strong> using email recovery procedure</li>
<li><strong>Extract account metadata:</strong></li>
</ol>
<pre class="astro-code dark-plus" style="background-color:#1E1E1E;color:#D4D4D4;overflow-x:auto" tabindex="0" data-language="sql"><code><span class="line"><span style="color:#569CD6">SELECT</span></span>
<span class="line"><span style="color:#D4D4D4">  id,</span></span>
<span class="line"><span style="color:#D4D4D4">  created_at,</span></span>
<span class="line"><span style="color:#D4D4D4">  updated_at,</span></span>
<span class="line"><span style="color:#D4D4D4">  last_login,</span></span>
<span class="line"><span style="color:#D4D4D4">  failed_attempts,</span></span>
<span class="line"><span style="color:#D4D4D4">  mfa_enabled</span></span>
<span class="line"><span style="color:#569CD6">FROM</span><span style="color:#D4D4D4"> users</span></span>
<span class="line"><span style="color:#569CD6">WHERE</span><span style="color:#D4D4D4"> email_hash = </span><span style="color:#CE9178">&#39;verified-hash&#39;</span><span style="color:#D4D4D4">;</span></span></code></pre>
<ol start="3">
<li><strong>Get audit trail:</strong></li>
</ol>
<pre class="astro-code dark-plus" style="background-color:#1E1E1E;color:#D4D4D4;overflow-x:auto" tabindex="0" data-language="sql"><code><span class="line"><span style="color:#569CD6">SELECT</span></span>
<span class="line"><span style="color:#569CD6">  action</span><span style="color:#D4D4D4">,</span></span>
<span class="line"><span style="color:#D4D4D4">  resource_type,</span></span>
<span class="line"><span style="color:#D4D4D4">  created_at,</span></span>
<span class="line"><span style="color:#6A9955">  -- Note: IP and user agent are encrypted</span></span>
<span class="line"><span style="color:#D4D4D4">  ip_address_encrypted,</span></span>
<span class="line"><span style="color:#D4D4D4">  user_agent_encrypted</span></span>
<span class="line"><span style="color:#569CD6">FROM</span><span style="color:#D4D4D4"> audit_log</span></span>
<span class="line"><span style="color:#569CD6">WHERE</span><span style="color:#D4D4D4"> user_id = </span><span style="color:#CE9178">&#39;user-uuid&#39;</span><span style="color:#D4D4D4">;</span></span></code></pre>
<ol start="4">
<li><strong>Session history:</strong></li>
</ol>
<pre class="astro-code dark-plus" style="background-color:#1E1E1E;color:#D4D4D4;overflow-x:auto" tabindex="0" data-language="sql"><code><span class="line"><span style="color:#569CD6">SELECT</span></span>
<span class="line"><span style="color:#D4D4D4">  created_at,</span></span>
<span class="line"><span style="color:#D4D4D4">  expires_at,</span></span>
<span class="line"><span style="color:#6A9955">  -- Note: IP and user agent are encrypted</span></span>
<span class="line"><span style="color:#D4D4D4">  ip_address_encrypted,</span></span>
<span class="line"><span style="color:#D4D4D4">  user_agent_encrypted</span></span>
<span class="line"><span style="color:#569CD6">FROM</span><span style="color:#569CD6"> sessions</span></span>
<span class="line"><span style="color:#569CD6">WHERE</span><span style="color:#D4D4D4"> user_id = </span><span style="color:#CE9178">&#39;user-uuid&#39;</span><span style="color:#D4D4D4">;</span></span></code></pre>
<p><strong>Note:</strong> Note content and titles cannot be exported as they’re encrypted client-side with keys we don’t have access to.</p>
<h2 id="security-considerations">Security Considerations</h2>
<h3 id="access-control">Access Control</h3>
<ul>
<li><strong>Principle of least privilege</strong>: Only authorized administrators should access GDPR procedures</li>
<li><strong>Audit logging</strong>: All GDPR operations are logged</li>
<li><strong>Two-person rule</strong>: Consider requiring two administrators for deletion operations</li>
</ul>
<h3 id="email-decryption-guidelines">Email Decryption Guidelines</h3>
<p>Only decrypt user emails when:</p>
<ul>
<li>✅ User explicitly requests data export</li>
<li>✅ Legal requirement with proper documentation</li>
<li>✅ Legitimate support need with user consent</li>
<li>❌ Never for marketing or analytics</li>
<li>❌ Never for unauthorized access</li>
</ul>
<h3 id="data-retention">Data Retention</h3>
<p>After user deletion:</p>
<ul>
<li><strong>Immediate</strong>: User cannot log in</li>
<li><strong>Within 24 hours</strong>: All user data removed from active database</li>
<li><strong>Within 30 days</strong>: Backup cleanup completed</li>
<li><strong>Audit logs</strong>: Deletion events are retained for compliance</li>
</ul>
<h2 id="troubleshooting">Troubleshooting</h2>
<h3 id="failed-deletion">Failed Deletion</h3>
<p>If automated deletion fails:</p>
<ol>
<li><strong>Check for foreign key constraints:</strong></li>
</ol>
<pre class="astro-code dark-plus" style="background-color:#1E1E1E;color:#D4D4D4;overflow-x:auto" tabindex="0" data-language="sql"><code><span class="line"><span style="color:#569CD6">SELECT</span></span>
<span class="line"><span style="color:#D4D4D4">  table_name,</span></span>
<span class="line"><span style="color:#D4D4D4">  constraint_name</span></span>
<span class="line"><span style="color:#569CD6">FROM</span><span style="color:#D4D4D4"> information_schema.table_constraints</span></span>
<span class="line"><span style="color:#569CD6">WHERE</span><span style="color:#D4D4D4"> constraint_type = </span><span style="color:#CE9178">&#39;FOREIGN KEY&#39;</span><span style="color:#D4D4D4">;</span></span></code></pre>
<ol start="2">
<li><strong>Manual cleanup of related data:</strong></li>
</ol>
<pre class="astro-code dark-plus" style="background-color:#1E1E1E;color:#D4D4D4;overflow-x:auto" tabindex="0" data-language="sql"><code><span class="line"><span style="color:#6A9955">-- Notes and attachments (should cascade)</span></span>
<span class="line"><span style="color:#569CD6">DELETE</span><span style="color:#569CD6"> FROM</span><span style="color:#D4D4D4"> notes </span><span style="color:#569CD6">WHERE</span><span style="color:#D4D4D4"> created_by = </span><span style="color:#CE9178">&#39;user-uuid&#39;</span><span style="color:#D4D4D4">;</span></span>
<span class="line"><span style="color:#569CD6">DELETE</span><span style="color:#569CD6"> FROM</span><span style="color:#D4D4D4"> attachments </span><span style="color:#569CD6">WHERE</span><span style="color:#D4D4D4"> created_by = </span><span style="color:#CE9178">&#39;user-uuid&#39;</span><span style="color:#D4D4D4">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955">-- Collaborations</span></span>
<span class="line"><span style="color:#569CD6">DELETE</span><span style="color:#569CD6"> FROM</span><span style="color:#D4D4D4"> collaborations </span><span style="color:#569CD6">WHERE</span><span style="color:#D4D4D4"> user_id = </span><span style="color:#CE9178">&#39;user-uuid&#39;</span><span style="color:#D4D4D4">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955">-- User roles</span></span>
<span class="line"><span style="color:#569CD6">DELETE</span><span style="color:#569CD6"> FROM</span><span style="color:#D4D4D4"> user_roles </span><span style="color:#569CD6">WHERE</span><span style="color:#D4D4D4"> user_id = </span><span style="color:#CE9178">&#39;user-uuid&#39;</span><span style="color:#D4D4D4">;</span></span></code></pre>
<h3 id="corrupted-gdpr-keys">Corrupted GDPR Keys</h3>
<p>If GDPR keys are corrupted:</p>
<ol>
<li><strong>User loses access to email recovery</strong></li>
<li><strong>Account can still be deleted by user ID</strong></li>
<li><strong>Document the incident for audit purposes</strong></li>
</ol>
<h3 id="database-migration-issues">Database Migration Issues</h3>
<p>When updating encryption:</p>
<ol>
<li><strong>Backup all GDPR keys</strong> before schema changes</li>
<li><strong>Test migration on copy</strong> of production data</li>
<li><strong>Verify email decryption</strong> works after migration</li>
<li><strong>Update documentation</strong> if procedures change</li>
</ol>
<h2 id="compliance-verification">Compliance Verification</h2>
<h3 id="monthly-checks">Monthly Checks</h3>
<ol>
<li><strong>Verify GDPR endpoints</strong> are functioning:</li>
</ol>
<pre class="astro-code dark-plus" style="background-color:#1E1E1E;color:#D4D4D4;overflow-x:auto" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#6A9955"># Test data export (use test account)</span></span>
<span class="line"><span style="color:#DCDCAA">curl</span><span style="color:#569CD6"> -X</span><span style="color:#CE9178"> POST</span><span style="color:#CE9178"> https://your-domain.com/api/v1/gdpr/request</span><span style="color:#D7BA7D"> \</span></span>
<span class="line"><span style="color:#569CD6">  -H</span><span style="color:#CE9178"> &quot;Content-Type: application/json&quot;</span><span style="color:#D7BA7D"> \</span></span>
<span class="line"><span style="color:#569CD6">  -d</span><span style="color:#CE9178"> &#39;{&quot;email&quot;: &quot;test@example.com&quot;}&#39;</span></span></code></pre>
<ol start="2">
<li><strong>Check deletion completeness:</strong></li>
</ol>
<pre class="astro-code dark-plus" style="background-color:#1E1E1E;color:#D4D4D4;overflow-x:auto" tabindex="0" data-language="sql"><code><span class="line"><span style="color:#6A9955">-- Should return no results after deletion</span></span>
<span class="line"><span style="color:#569CD6">SELECT</span><span style="color:#DCDCAA"> COUNT</span><span style="color:#D4D4D4">(*) </span><span style="color:#569CD6">FROM</span><span style="color:#D4D4D4"> users </span><span style="color:#569CD6">WHERE</span><span style="color:#D4D4D4"> email_hash = </span><span style="color:#CE9178">&#39;deleted-user-hash&#39;</span><span style="color:#D4D4D4">;</span></span>
<span class="line"><span style="color:#569CD6">SELECT</span><span style="color:#DCDCAA"> COUNT</span><span style="color:#D4D4D4">(*) </span><span style="color:#569CD6">FROM</span><span style="color:#D4D4D4"> gdpr_keys </span><span style="color:#569CD6">WHERE</span><span style="color:#D4D4D4"> email_hash = </span><span style="color:#CE9178">&#39;deleted-user-hash&#39;</span><span style="color:#D4D4D4">;</span></span></code></pre>
<ol start="3">
<li><strong>Audit log review:</strong></li>
</ol>
<pre class="astro-code dark-plus" style="background-color:#1E1E1E;color:#D4D4D4;overflow-x:auto" tabindex="0" data-language="sql"><code><span class="line"><span style="color:#569CD6">SELECT</span></span>
<span class="line"><span style="color:#569CD6">  action</span><span style="color:#D4D4D4">,</span></span>
<span class="line"><span style="color:#DCDCAA">  COUNT</span><span style="color:#D4D4D4">(*) </span><span style="color:#569CD6">as</span><span style="color:#D4D4D4"> count</span></span>
<span class="line"><span style="color:#569CD6">FROM</span><span style="color:#D4D4D4"> audit_log</span></span>
<span class="line"><span style="color:#569CD6">WHERE</span><span style="color:#569CD6"> action</span><span style="color:#569CD6"> LIKE</span><span style="color:#CE9178"> &#39;%gdpr%&#39;</span></span>
<span class="line"><span style="color:#569CD6">  AND</span><span style="color:#D4D4D4"> created_at &gt;= </span><span style="color:#569CD6">NOW</span><span style="color:#D4D4D4">() - INTERVAL </span><span style="color:#CE9178">&#39;30 days&#39;</span></span>
<span class="line"><span style="color:#569CD6">GROUP BY</span><span style="color:#569CD6"> action</span><span style="color:#D4D4D4">;</span></span></code></pre>
<h2 id="emergency-procedures">Emergency Procedures</h2>
<h3 id="data-breach-response">Data Breach Response</h3>
<p>If GDPR keys are compromised:</p>
<ol>
<li><strong>Immediate action</strong>: Disable GDPR endpoints</li>
<li><strong>Assessment</strong>: Determine scope of key exposure</li>
<li><strong>User notification</strong>: Contact affected users</li>
<li><strong>Key rotation</strong>: Generate new GDPR keys for remaining users</li>
<li><strong>Documentation</strong>: Full incident report</li>
</ol>
<h3 id="system-recovery">System Recovery</h3>
<p>After system restore:</p>
<ol>
<li><strong>Verify GDPR key integrity</strong></li>
<li><strong>Test email decryption</strong> for sample accounts</li>
<li><strong>Validate deletion procedures</strong></li>
<li><strong>Check audit log completeness</strong></li>
</ol>
<h2 id="contact-information">Contact Information</h2>
<p>For GDPR operations support:</p>
<ul>
<li><strong>Technical issues</strong>: <code>tech@leaflock.app</code></li>
<li><strong>Legal questions</strong>: <code>legal@leaflock.app</code></li>
<li><strong>Emergency contact</strong>: <code>emergency@leaflock.app</code></li>
</ul>
<hr/>
<p><strong>⚠️ Security Reminder</strong>: This guide contains sensitive procedures. Ensure it’s only accessible to authorized personnel and regularly review access permissions.</p>
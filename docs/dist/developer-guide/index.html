<!DOCTYPE html><meta charset="utf-8"/><p><em>Last updated: 2025-09-19</em></p>
<h2 id="overview">Overview</h2>
<p>This guide provides technical information for developers working with LeafLock, including API documentation, testing, scripts, and development workflows.</p>
<h2 id="api-documentation-swagger">API Documentation (Swagger)</h2>
<p>Admin-only Swagger API documentation is available at:</p>
<ul>
<li><strong>UI</strong>: <code>/api/v1/docs</code></li>
<li><strong>Spec</strong>: <code>/api/v1/docs/openapi.json</code></li>
</ul>
<p>All endpoints are documented in <code>backend/docs/openapi.json</code>.</p>
<h3 id="authentication">Authentication</h3>
<ul>
<li>Add a JWT bearer token (from <code>/auth/register</code> or <code>/auth/login</code>)</li>
<li>Access requires <code>admin</code> role</li>
</ul>
<h3 id="testing-locally">Testing Locally</h3>
<ul>
<li>Bootstrap by setting <code>ADMIN_USER_IDS=&lt;your-user-id&gt;</code> and restart backend</li>
<li>Open the UI and try the admin endpoints</li>
</ul>
<h3 id="contributing-to-the-spec">Contributing to the Spec</h3>
<ul>
<li>Update <code>backend/docs/openapi.json</code> and include:
<ul>
<li>Request/response schemas in <code>components.schemas</code></li>
<li>Examples in <code>responses[*].content[*].examples</code></li>
<li>Security requirements as needed</li>
</ul>
</li>
</ul>
<h2 id="role-based-access-control-rbac">Role-Based Access Control (RBAC)</h2>
<h3 id="roles">Roles</h3>
<ul>
<li><strong>admin</strong>: Full access to admin APIs and Swagger docs</li>
<li><strong>moderator</strong>: Reserved for future moderation actions</li>
<li><strong>auditor</strong>: Read-only reports in future</li>
<li><strong>user</strong>: Default role for every user</li>
</ul>
<p>Roles are stored in tables <code>roles</code> and <code>user_roles</code>. Users also have a boolean <code>is_admin</code> for quick admin flag checking.</p>
<h3 id="admin-apis">Admin APIs</h3>
<ul>
<li><code>GET /api/v1/admin/health</code></li>
<li><code>PUT /api/v1/admin/users/:id/admin</code> <code>{ &quot;admin&quot;: true|false }</code></li>
<li><code>GET /api/v1/admin/roles</code></li>
<li><code>GET /api/v1/admin/users/:id/roles</code></li>
<li><code>POST /api/v1/admin/users/:id/roles</code> <code>{ &quot;role&quot;: &quot;moderator&quot; }</code></li>
<li><code>DELETE /api/v1/admin/users/:id/roles/:role</code></li>
</ul>
<p>All admin endpoints require JWT and <code>admin</code> role.</p>
<h3 id="local-bootstrap">Local Bootstrap</h3>
<ul>
<li>Temporary allowlist via env var: <code>ADMIN_USER_IDS=uuid1,uuid2</code></li>
<li>Use it to grant first admin, then set <code>is_admin</code> via API</li>
</ul>
<h2 id="rate-limiting">Rate Limiting</h2>
<h3 id="registration-rate-limiting">Registration Rate Limiting</h3>
<p>To reduce abuse in non-local environments, the registration endpoint is rate-limited.</p>
<ul>
<li><strong>Endpoint</strong>: <code>POST /api/v1/auth/register</code></li>
<li><strong>Limit</strong>: 5 requests per minute per IP</li>
<li><strong>Enabled when</strong>: <code>APP_ENV</code> is not <code>development</code> or <code>local</code></li>
</ul>
<h3 id="configuration">Configuration</h3>
<ul>
<li><code>APP_ENV=production</code> enables limiting</li>
<li><code>APP_ENV=development</code> disables limiting for local dev</li>
<li>General app rate limiting (100/min/IP) still applies globally</li>
</ul>
<h2 id="scripts-and-automation">Scripts and Automation</h2>
<p>Use <code>./leaflock.sh</code> for common tasks:</p>
<pre class="astro-code dark-plus" style="background-color:#1E1E1E;color:#D4D4D4;overflow-x:auto" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#DCDCAA">./leaflock.sh</span><span style="color:#CE9178"> help</span></span>
<span class="line"><span style="color:#DCDCAA">./leaflock.sh</span><span style="color:#CE9178"> icons</span><span style="color:#6A9955">          # regenerate icons</span></span>
<span class="line"><span style="color:#DCDCAA">./leaflock.sh</span><span style="color:#CE9178"> railway</span><span style="color:#6A9955">        # bootstrap Railway backend+frontend</span></span>
<span class="line"><span style="color:#DCDCAA">./leaflock.sh</span><span style="color:#CE9178"> docker:up</span><span style="color:#6A9955">      # compose up -d --build</span></span>
<span class="line"><span style="color:#DCDCAA">./leaflock.sh</span><span style="color:#CE9178"> docker:down</span></span>
<span class="line"><span style="color:#DCDCAA">./leaflock.sh</span><span style="color:#CE9178"> docker:build</span></span>
<span class="line"><span style="color:#DCDCAA">./leaflock.sh</span><span style="color:#CE9178"> k8s:deploy</span><span style="color:#6A9955">     # wrapper for deploy-k8s.sh</span></span>
<span class="line"><span style="color:#DCDCAA">./leaflock.sh</span><span style="color:#CE9178"> health</span><span style="color:#6A9955">         # wrapper for health-check.sh</span></span>
<span class="line"><span style="color:#DCDCAA">./leaflock.sh</span><span style="color:#CE9178"> troubleshoot</span><span style="color:#6A9955">   # wrapper for troubleshoot.sh</span></span>
<span class="line"><span style="color:#DCDCAA">./leaflock.sh</span><span style="color:#CE9178"> test</span><span style="color:#6A9955">           # wrapper for test-automation.sh</span></span></code></pre>
<h3 id="specialized-scripts">Specialized Scripts</h3>
<p>Advanced scripts for CI or specific workflows:</p>
<ul>
<li><code>deploy-k8s.sh</code>, <code>deploy.sh</code>, <code>deploy-docker.sh</code>, <code>deploy-from-ghcr.sh</code></li>
<li><code>setup-docker.sh</code>, <code>setup-podman.sh</code>, <code>podman-kube-play.sh</code></li>
<li><code>health-check.sh</code>, <code>troubleshoot.sh</code>, <code>test-automation.sh</code></li>
<li><code>env-setup.sh</code>, <code>dev-setup.sh</code>, <code>dev-watch.sh</code>, <code>init-ssl*.sh</code></li>
</ul>
<p><strong>Recommendation</strong>: Start with <code>leaflock.sh</code>. Use specialized scripts for fine-grained control or CI integration.</p>
<h2 id="icons-and-assets">Icons and Assets</h2>
<p>LeafLock ships with a full set of favicons and PWA icons generated from the LeafLock motif.</p>
<h3 id="assets-included">Assets Included</h3>
<ul>
<li><code>favicon.svg</code> (scalable primary icon)</li>
<li><code>favicon.ico</code> (multi-image 16/32/48)</li>
<li><code>favicon-16.png</code>, <code>favicon-32.png</code>, <code>favicon-48.png</code>, <code>favicon-64.png</code></li>
<li><code>apple-touch-icon.png</code> (180Ã—180)</li>
<li><code>icon-192.png</code>, <code>icon-512.png</code></li>
<li><code>icon-192-maskable.png</code>, <code>icon-512-maskable.png</code> (safe padding for maskable PWAs)</li>
</ul>
<h3 id="regenerating-icons">Regenerating Icons</h3>
<p>If you customize branding:</p>
<pre class="astro-code dark-plus" style="background-color:#1E1E1E;color:#D4D4D4;overflow-x:auto" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#DCDCAA">node</span><span style="color:#CE9178"> scripts/generate-icons.mjs</span></span></code></pre>
<h3 id="html-reference">HTML Reference</h3>
<p>For single reference in HTML:</p>
<pre class="astro-code dark-plus" style="background-color:#1E1E1E;color:#D4D4D4;overflow-x:auto" tabindex="0" data-language="html"><code><span class="line"><span style="color:#808080">&lt;</span><span style="color:#569CD6">link</span><span style="color:#9CDCFE"> rel</span><span style="color:#D4D4D4">=</span><span style="color:#CE9178">&quot;icon&quot;</span><span style="color:#9CDCFE"> type</span><span style="color:#D4D4D4">=</span><span style="color:#CE9178">&quot;image/svg+xml&quot;</span><span style="color:#9CDCFE"> href</span><span style="color:#D4D4D4">=</span><span style="color:#CE9178">&quot;/favicon.svg&quot;</span><span style="color:#808080"> /&gt;</span></span></code></pre>
<h2 id="testing-and-cicd">Testing and CI/CD</h2>
<h3 id="e2e-verification-workflow">E2E Verification Workflow</h3>
<p>Located at <code>.github/workflows/e2e-verify.yml</code></p>
<p><strong>What it does:</strong></p>
<ul>
<li>Runs frontend lint, typecheck, tests</li>
<li>Builds and starts Postgres, Redis, backend, frontend via <code>docker compose</code></li>
<li>Waits for readiness and tests API flow (register + list notes)</li>
<li>Smoke tests frontend (index + asset)</li>
<li>Runs backend tests with coverage gate</li>
<li>Verifies Swagger access with <code>ADMIN_USER_IDS</code> fallback, then via RBAC grant</li>
</ul>
<p><strong>Admin panel in E2E:</strong></p>
<ul>
<li>Sets <code>VITE_ENABLE_ADMIN_PANEL=true</code> so the UI contains the Admin section</li>
</ul>
<h2 id="development-setup">Development Setup</h2>
<p>Refer to the main <code>CLAUDE.md</code> file in the repository root for:</p>
<ul>
<li>Environment setup</li>
<li>Development commands</li>
<li>Container operations</li>
<li>Technology stack details</li>
<li>Required environment variables</li>
</ul>
<h2 id="contributing">Contributing</h2>
<p>When contributing to LeafLock:</p>
<ol>
<li>Follow the existing code style and patterns</li>
<li>Update relevant documentation</li>
<li>Add tests for new features</li>
<li>Update API documentation if adding new endpoints</li>
<li>Test admin functionality if making admin-related changes</li>
</ol>
<h2 id="contact">Contact</h2>
<p>For technical questions, contact <code>contact@leaflock.app</code>.</p>
<!DOCTYPE html><html lang="en"> <head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Untitled</title><meta name="description" content><link rel="icon" type="image/svg+xml" href="/favicon.svg"><!-- Open Graph --><meta property="og:title" content="Untitled"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:site_name" content="LeafLock Documentation"><!-- Twitter Card --><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Untitled"><meta name="twitter:description" content><!-- Import CSS --><link rel="stylesheet" href="/assets/admin-guide.CEgvpTZl.css"></head> <body> <header class="site-header"> <div class="container"> <a class="brand" href="/">LeafLock</a> <nav> <ul> <li><a href="/pages/">Documentation</a></li> <li><a href="https://github.com/RelativeSure/LeafLock">Repository</a></li> </ul> </nav> </div> </header> <main id="main-content" class="container">  <article class="content"> <h1>Untitled</h1> <div class="meta">    </div> <div class="markdown"> 
# Monitoring and Backups

LeafLock now includes comprehensive monitoring with Prometheus metrics and automated backup capabilities with S3 support.

## Prometheus Metrics

### Enabling Metrics

Metrics are enabled by default. To disable them, set `ENABLE_METRICS=false` in your environment.

### Available Metrics

The application exposes the following metrics at `/metrics`:

#### HTTP Metrics
- `leaflock_http_requests_total` - Total HTTP requests by method, endpoint, and status code
- `leaflock_http_request_duration_seconds` - HTTP request duration histogram

#### Application Metrics
- `leaflock_active_users` - Number of currently active users
- `leaflock_notes_total` - Total notes operations (create, update, delete)
- `leaflock_collaborations_active` - Number of active collaborations
- `leaflock_websocket_connections` - Active WebSocket connections

#### Database Metrics
- `leaflock_db_connections_active` - Active database connections
- `leaflock_db_connections_idle` - Idle database connections
- `leaflock_db_queries_total` - Total database queries by operation

#### Redis Metrics
- `leaflock_redis_connections_active` - Active Redis connections
- `leaflock_redis_operations_total` - Total Redis operations

#### Error Metrics
- `leaflock_errors_total` - Total errors by type and component

#### Backup Metrics
- `leaflock_backups_total` - Total backup operations by status
- `leaflock_backup_duration_seconds` - Backup duration histogram
- `leaflock_backup_size_bytes` - Last backup size

### Accessing Metrics

```bash
# Check if metrics are enabled
curl http://localhost:8080/metrics

# View specific metrics
curl http://localhost:8080/metrics | grep leaflock_notes_total
```

## Automated S3 Backups

### Configuration

Add the following environment variables to your `.env` file:

```bash
# Enable backups
ENABLE_BACKUPS=true

# S3 Configuration
BACKUP_S3_BUCKET=your-backup-bucket-name
BACKUP_S3_ACCESS_KEY=your_access_key
BACKUP_S3_SECRET_KEY=your_secret_key
BACKUP_S3_REGION=us-east-1
BACKUP_S3_ENDPOINT=https://s3.amazonaws.com

# Backup encryption (32 characters)
BACKUP_ENCRYPTION_KEY=your_32_character_encryption_key

# Schedule (cron format) - default: daily at 2 AM
BACKUP_SCHEDULE=0 2 * * *

# Retention (days) - default: 30 days
BACKUP_RETENTION_DAYS=30
```

### S3 Bucket Setup

1. Create an S3 bucket for backups
2. Create an IAM user with the following policy:

```json
{
    &quot;Version&quot;: &quot;2012-10-17&quot;,
    &quot;Statement&quot;: [
        {
            &quot;Effect&quot;: &quot;Allow&quot;,
            &quot;Action&quot;: [
                &quot;s3:PutObject&quot;,
                &quot;s3:GetObject&quot;,
                &quot;s3:DeleteObject&quot;,
                &quot;s3:ListBucket&quot;
            ],
            &quot;Resource&quot;: [
                &quot;arn:aws:s3:::your-backup-bucket/*&quot;,
                &quot;arn:aws:s3:::your-backup-bucket&quot;
            ]
        }
    ]
}
```

### Backup Features

- **Encrypted backups**: All backups are encrypted with AES-256
- **Automatic retention**: Old backups are automatically cleaned up
- **Health monitoring**: Backup status is exposed via Prometheus metrics
- **Manual restore**: Use the restore script for point-in-time recovery

### Running Backups

#### With Docker Compose

```bash
# Start with backup service
make up

# Run immediate backup
docker compose exec backup /usr/local/bin/backup.sh

# View backup logs
docker compose logs backup -f
```

#### Manual Backup

```bash
# Run backup script directly
./scripts/backup.sh

# List available backups
./scripts/restore.sh --list

# Restore from specific backup
./scripts/restore.sh --file backups/2025/01/21/leaflock_backup_20250121_020000.sql.gz.enc
```

### Backup Storage Structure

Backups are stored in S3 with the following structure:

```
s3://your-bucket/
└── backups/
    └── 2025/
        └── 01/
            └── 21/
                ├── leaflock_backup_20250121_020000.sql.gz.enc
                ├── leaflock_backup_20250121_140000.sql.gz.enc
                └── ...
```

## Kubernetes Monitoring

When deploying with Helm, monitoring is automatically configured:

### ServiceMonitor

The chart creates a ServiceMonitor for Prometheus Operator:

```yaml
monitoring:
  enabled: true
  serviceMonitor:
    enabled: true
    namespace: monitoring
    interval: 30s
```

### Prometheus Rules

Pre-configured alerts include:

- `LeafLockBackendDown` - Backend service is unavailable
- `LeafLockHighErrorRate` - High error rate detected
- `LeafLockBackupFailed` - Backup operation failed

### Backup CronJob

Automated backups run as a Kubernetes CronJob:

```yaml
backup:
  enabled: true
  schedule: "0 2 * * *"
  retentionDays: 30
```

## Grafana Dashboard

A sample Grafana dashboard is available at `docs/grafana-dashboard.json` with:

- Request rate and latency graphs
- Error rate monitoring
- Database and Redis connection metrics
- Backup status and size tracking
- Active user and collaboration counts

## Troubleshooting

### Metrics Not Working

1. Check `ENABLE_METRICS` environment variable
2. Verify `/metrics` endpoint is accessible
3. Check application logs for errors

### Backup Failures

1. Verify S3 credentials and permissions
2. Check `BACKUP_ENCRYPTION_KEY` is set
3. Review backup logs: `docker compose logs backup`
4. Test S3 connectivity manually

### Common Issues

- **Permission denied**: Ensure backup user has write access to `/tmp/backups`
- **S3 access denied**: Verify IAM policy allows required S3 operations
- **Encryption errors**: Ensure `BACKUP_ENCRYPTION_KEY` is exactly 32 characters
- **Database connection**: Check PostgreSQL connection from backup container

## Security Considerations

- Backup encryption keys should be stored securely
- S3 credentials should use least-privilege IAM policies
- Regular backup restore testing is recommended
- Metrics endpoint should be secured in production environments
 </div> </article>  </main> <footer class="site-footer"> <div class="container"> <div class="footer-links"> <div> <h2>LeafLock Docs</h2> <ul> <li><a href="/pages/privacy-policy/">Privacy Policy</a></li> <li><a href="/pages/terms-of-use/">Terms of Use</a></li> <li><a href="/pages/gdpr-compliance/">GDPR Compliance</a></li> </ul> </div> <div> <h2>Administration</h2> <ul> <li><a href="/pages/admin-guide/">Admin Guide</a></li> <li><a href="/pages/monitoring-and-backups/">Monitoring & Backups</a></li> </ul> </div> <div> <h2>Development</h2> <ul> <li><a href="/pages/developer-guide/">Developer Guide</a></li> <li><a href="https://github.com/RelativeSure/LeafLock">GitHub Repository</a></li> </ul> </div> </div> <div style="text-align: center; margin-top: 2rem; color: var(--text-muted); font-size: 0.9rem;">
© 2025 LeafLock. All rights reserved.
</div> </div> </footer> <!-- Schema.org structured data --> <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "LeafLock Documentation",
      "description": "Secure, end-to-end encrypted notes with zero-knowledge architecture",
      "url": "https://docs.leaflock.app/"
    }
    </script> </body> </html>
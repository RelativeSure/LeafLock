---
title: Monitoring and Backups
description: Observe LeafLock runtime health and track encrypted data backups.
sidebar:
  order: 2
---

import { Code } from '@astrojs/starlight/components';

## Monitoring Overview
LeafLock exposes native Prometheus metrics under `/metrics`. Set `ENABLE_METRICS=true` (default) to keep the handler active. In production place the endpoint behind an internal network or require an authorization proxy.

<Code
  code={`curl -s http://localhost:8080/metrics | grep leaflock_`}
  language="bash"
/>

## Metric Families

### Encryption and Collaboration Signals
- `leaflock_active_users` – authenticated sessions currently online (WebSocket handshake counts only after encryption keys are exchanged).
- `leaflock_notes_total` – CRUD operations against encrypted notes; spikes indicate key rotation or bulk import activity.
- `leaflock_collaborations_active` – live shared workspaces.
- `leaflock_websocket_connections` – concurrent encrypted channels between browser clients and the collaboration service.

### API Surface
- `leaflock_http_requests_total` – labelled by method, route, and status.
- `leaflock_http_request_duration_seconds` – histogram for call latency. Track the `admin` and `auth` buckets separately because MFA and key generation have higher variance.
- `leaflock_errors_total` – aggregated by component for alerting.

### Persistence Layers
- `leaflock_db_connections_active` / `leaflock_db_connections_idle` – monitor connection pool tuning for PostgreSQL.
- `leaflock_db_queries_total` – emitted per statement type (select, insert, update, delete).
- `leaflock_redis_connections_active` / `leaflock_redis_operations_total` – ensure session cache pressure stays within limits.

### Backup Lifecycle
- `leaflock_backups_total{status="success|failed"}` – incremented by the backup runner for each execution.
- `leaflock_backup_duration_seconds` – execution time histogram (slow runs usually mean S3 throttling or large WAL delta).
- `leaflock_backup_size_bytes` – last successful archive size.

## Alerting Baselines
- trigger on `leaflock_http_errors_total{component="api"}` rate > 5/min with a 10 minute window.
- alert when `leaflock_websocket_connections` drops to zero while `leaflock_active_users` > 0.
- investigate `leaflock_backup_duration_seconds` p95 > 600s; this usually precedes S3 timeout errors.
- page when no successful backup has been observed for 24 hours: `max_over_time(leaflock_backups_total{status="success"}[24h]) == 0`.

## Dashboards
Prometheus/Grafana dashboards should graph the metric families above plus runtime logs tagged with `component=auth` and `component=backup`. A starter dashboard lives in `docs/grafana-dashboard.json`; import it and point the Prometheus datasource at the `/metrics` scrape target.

## Backup Execution
LeafLock ships a single backup runner with S3-compatible output. Configure the backup-related variables documented in `/reference/environment-variables` (`ENABLE_BACKUPS`, `BACKUP_S3_BUCKET`, encryption key, schedule). The job reports directly into the metrics listed earlier.

Deployment-specific runbooks contain the operational commands for each platform:
- Docker / Podman: `/deployment/docker/#backup--recovery`
- Kubernetes: `/deployment/kubernetes/#backup-and-recovery`
- Railway: `/deployment/railway/#database-migrations-and-backups`

Use those guides for cron schedules, restore commands, and IAM examples. This page focuses on observing the outcome and wiring metrics into your alerting stack.

## Troubleshooting
- **Metrics endpoint empty**: verify `ENABLE_METRICS=true` and that your reverse proxy forwards requests to `/metrics` without stripping headers.
- **Missing backup samples**: confirm the backup container logs `backup completed` and that the schedule (cron expression) is valid.
- **Inconsistent `leaflock_active_users` counts**: ensure WebSocket ingress traffic terminates TLS before proxying to the backend; TLS termination errors prevent the session increment hook from running.

Backups are only useful when tested regularly. Schedule restore drills alongside monitoring to guarantee encrypted archives remain decryptable with your stored keys.

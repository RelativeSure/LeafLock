---
title: User Management
description: Technical procedures for provisioning admins and operating accounts in LeafLock.
sidebar:
  order: 1
---

import { Aside, Card, CardGrid, Code } from '@astrojs/starlight/components';

## Overview
LeafLock operates under a zero-knowledge model: administrators only see metadata such as emails, timestamps, and security signals. This guide documents the sanctioned flows for elevating operators, enforcing access policy, and running maintenance without violating encryption guarantees.

## Bootstrap an Admin Account

<CardGrid columns={3}>
  <Card title="Identify User" icon="search">
    Retrieve the UUID after the user signs in. Decode the JWT stored in `secure_token`:

    <Code
      code={`const token = localStorage.getItem('secure_token');
const payload = JSON.parse(atob(token.split('.')[1]));
console.log(payload.user_id);`}
      language="javascript"
    />

    Alternative: read `current_user_id` from Local Storage.
  </Card>
  <Card title="Allowlist UUID" icon="shield">
    Supply the UUID via environment variable and restart the backend stack.

    <Code code={`ADMIN_USER_IDS=1c0fe4f0-9d41-41cc-8806-b5e8f6a2ad71`} language="env" />

    Comma-separate multiple bootstrap admins.
  </Card>
  <Card title="Persist Role" icon="approve-check">
    Promote the user permanently with the API (`PATCH /api/v1/admin/users/:id`) or SQL:

    <Code
      code={`UPDATE users
SET is_admin = true
WHERE id = '1c0fe4f0-9d41-41cc-8806-b5e8f6a2ad71';`}
      language="sql"
    />

    `idx_users_is_admin` keeps this update O(log n). Remove access by setting `is_admin = false`.
  </Card>
</CardGrid>

<Aside type="note" title="Zero-Knowledge Constraint">
Admins never gain decryption keys; they can only manage metadata, quotas, and policy toggles.
</Aside>

## Admin Panel Configuration

- Enable the UI by exporting `VITE_ENABLE_ADMIN_PANEL=true` before building the frontend (for local use: `export VITE_ENABLE_ADMIN_PANEL=true && make up`).
- Sign in with an admin account and select the shield icon to open the panel.
- Panel functions map 1:1 to backend APIs:
  - Toggle `is_admin` and assign RBAC roles (`moderator`, `auditor`).
  - Unlock accounts and clear password-reset locks.
  - Flip public registration (`app_settings.registration_enabled`).
  - Review authentication telemetry (failed attempts, last login).

JWT validation plus the `is_admin` column gate every request; the UI toggle is a convenience layer only.

## Database Operations Reference

<CardGrid>
  <Card title="Account Inventory" icon="list-format">
    <Code
      code={`SELECT
    id,
    email,
    COALESCE(is_admin, false) AS is_admin,
    mfa_enabled,
    failed_attempts,
    locked_until,
    created_at,
    last_login
FROM users
ORDER BY created_at DESC;`}
      language="sql"
    />
  </Card>
  <Card title="Admin Audit" icon="user">
    <Code
      code={`SELECT id, email, created_at, last_login
FROM users
WHERE is_admin = true;`}
      language="sql"
    />
  </Card>
  <Card title="Lockout Detection" icon="alert-triangle">
    <Code
      code={`SELECT id, email, failed_attempts, locked_until
FROM users
WHERE failed_attempts > 5;`}
      language="sql"
    />
  </Card>
</CardGrid>

### Account Recovery

<Code
  code={`UPDATE users
SET failed_attempts = 0,
    locked_until = NULL
WHERE id = 'user-uuid';`}
  language="sql"
/>

Demote an admin when access is no longer required:

<Code
  code={`UPDATE users
SET is_admin = false
WHERE id = 'user-uuid';`}
  language="sql"
/>

### MFA Flags

<Code
  code={`UPDATE users
SET mfa_enabled = true
WHERE id = 'user-uuid';

UPDATE users
SET mfa_enabled = false,
    mfa_secret_encrypted = NULL
WHERE id = 'user-uuid';`}
  language="sql"
/>

### Storage and Usage Telemetry

<Code
  code={`SELECT
    id,
    storage_used,
    storage_limit,
    ROUND(storage_used::numeric / storage_limit * 100, 1) AS usage_percent
FROM users
WHERE storage_limit > 0
ORDER BY usage_percent DESC;`}
  language="sql"
/>

<Code
  code={`SELECT
    u.email,
    COUNT(n.id) AS note_count
FROM users u
LEFT JOIN workspaces w ON u.id = w.owner_id
LEFT JOIN notes n ON w.id = n.workspace_id AND n.deleted_at IS NULL
GROUP BY u.id, u.email
ORDER BY note_count DESC;`}
  language="sql"
/>

Aggregate statistics for dashboards:

<Code
  code={`SELECT COUNT(*) AS total_users FROM users;
SELECT COUNT(*) AS active_users FROM users WHERE last_login > NOW() - INTERVAL '30 days';
SELECT COUNT(*) AS locked_accounts FROM users WHERE locked_until > NOW();`}
  language="sql"
/>

## Registration Controls

Public registration is disabled by default. Enable it when you intend to accept new users via the API or admin panel:

<Code code={`ENABLE_REGISTRATION=true`} language="env" />

The panel writes the same value into `app_settings.registration_enabled`. During boot the backend seeds the column from the environment only when no record exists.

## Operational Boundaries

<CardGrid columns={3}>
  <Card title="Encrypted Payloads" icon="lock">
    Note contents remain unreadable to admins. Only metadata and audit signals are exposed.
  </Card>
  <Card title="Reset Workflow" icon="workflow">
    Run password resets through the standard flow to preserve encryption keys; never edit hashed columns manually.
  </Card>
  <Card title="Backups" icon="database">
    Snapshot before destructive updates:

    <Code
      code={`pg_dump -h localhost -U postgres -d notes -t users > users_backup.sql`}
      language="bash"
    />
  </Card>
</CardGrid>

## Maintenance Jobs

- Emergency unlock admins: `UPDATE users SET failed_attempts = 0, locked_until = NULL WHERE is_admin = true;`
- Purge soft-deleted notes after retention: `DELETE FROM notes WHERE deleted_at IS NOT NULL AND deleted_at < NOW() - INTERVAL '30 days';`
- Stream auth logs (`component=auth`) into your SIEM to detect brute-force attempts.

Refer to `/docs/reference/environment-variables` for the authoritative list of configuration toggles that impact administration.
